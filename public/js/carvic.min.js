////////////////////////////////////////////////////////////////////
function ComponentLookup(e,t){var n=["a","b","c"];t(n)}var Carvic={Model:{HasErrors:ko.observable(""),ErrorMsg:ko.observable("")}},now=new Date;Carvic.Model.StdData=function(){var e=this;e.Error=ko.observable(""),e.HasErrors=ko.observable(!1),e.CurrentUserFullname=ko.observable(""),e.CurrentUsername=ko.observable(""),e.CurrentUserTooltip=ko.computed(function(){return"Logged in: "+e.CurrentUserFullname()+" ("+e.CurrentUsername()+")"},e)},Carvic.Utils={AddUsersLink:function(){$("#liUsers").length==0&&$("#ulNav").append('<li><a href="users.html"><i class="icon-group"></i> Users</a></li>')},LoadClusterList:function(e){var t={};Carvic.Utils.Post({action:"get_clusters",data:t},function(t){for(var n=0;n<t.length;n++){var r=t[n];e.push({code:r.id,title:r.name})}})},LoadUserList:function(e){var t={};Carvic.Utils.Post({action:"get_users",data:t},function(t){for(var n=0;n<t.length;n++){var r=t[n];e.push({code:r.username,title:r.full_name})}})},ConnectInputWithDesc:function(e){$(e).on("focus",function(e){e.preventDefault();var t=$(this),n=t.next();n.collapse("toggle")}),$(e).on("blur",function(e){e.preventDefault();var t=$(this),n=t.next();n.collapse("toggle")})},ClusterLookupCache:null,ClusterLookup:function(e,t){if(Carvic.Utils.ClusterLookupCache!=null)t(Carvic.Utils.ClusterLookupCache);else{var n={action:"cluster_list",data:{}};Carvic.Utils.Post(n,function(e){Carvic.Utils.ClusterLookupCache=e,t(Carvic.Utils.ClusterLookupCache)})}},ComponentLookup:function(e,t){var n={action:"lookup_component",data:{search_str:e}};Carvic.Utils.Post(n,function(e){t(e)})},Logout:function(){var e=""+document.location;document.location="/logout"},SetCurrentUser:function(e,t){e.StdData=new Carvic.Model.StdData;var n={action:"get_current_user",data:{}};Carvic.Utils.Post(n,function(n){e.StdData.CurrentUserFullname(n.full_name),e.StdData.CurrentUsername(n.username),n.type=="admin"&&Carvic.Utils.AddUsersLink(),t&&t()})},ParseDate:function(e,t){t=t||null;var n=e.split(".");if(n.length!=3)return t;var r=Number(n[2]),i=Number(n[1]),s=Number(n[0]);return r===NaN||i===NaN||s===NaN?t:new Date(r,i-1,s)},GetDatePart:function(e){var t=e.getDate(),n=e.getMonth(),r=e.getFullYear();return new Date(r,n,t)},FormatDate:function(e){if(e===undefined||!e)return"";var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear();return Carvic.Utils.Pad(t,2)+"."+Carvic.Utils.Pad(n,2)+"."+r},FormatDateTime:function(e){if(e===undefined||!e)return"";var t=e.getHours(),n=e.getMinutes(),r=e.getSeconds();return Carvic.Utils.FormatDate(e)+" "+t+":"+Carvic.Utils.Pad(n,2)+":"+Carvic.Utils.Pad(r,2)},FormatDateTime2:function(e){if(e===undefined||!e)return"";var t=e.getHours(),n=e.getMinutes();return Carvic.Utils.FormatDate(e)+" "+t+":"+Carvic.Utils.Pad(n,2)},FormatMoney:function(e){var t=2,n=".",r=",",i=e,t=isNaN(t=Math.abs(t))?2:t,r=r==undefined?".":r,n=n==undefined?",":n,s=i<0?"-":"",o=parseInt(i=Math.abs(+i||0).toFixed(t))+"",u=(u=o.length)>3?u%3:0;return s+(u?o.substr(0,u)+n:"")+o.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+n)+(t?r+Math.abs(i-o).toFixed(t).slice(2):"")},CreateMap:function(e,t){var n={};for(var r in e){var i=e[r];n[i[t]]=i}return n},CheckMatch:function(e,t){var n=!0;for(var r in t)if(e[r]!==t[r]){n=!1;break}return n},GetMatches:function(e,t){var n=[];for(var r in t){var i=t[r];Carvic.Utils.CheckMatch(i,e)&&n.push(i)}return n},Post:function(e,t,n){$.ajax({type:"POST",url:"/handler",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){var r=JSON.parse(e);r.error==null?(Carvic.Model.HasErrors(!1),t(r)):(Carvic.Model.ErrorMsg(r.error.message),Carvic.Model.HasErrors(!0),n?n(Carvic.Model.ErrorMsg()):alert(Carvic.Model.ErrorMsg()))},error:function(e,t,r){Carvic.Model.HasErrors(!0),Carvic.Model.ErrorMsg(""+(r||t)),n?n(Carvic.Model.ErrorMsg()):alert(Carvic.Model.ErrorMsg())},dataType:"text",processData:!1})},GetUrlParam:function(e){var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(window.location.href);return n!=null?n[1]:null},Pad:function(e,t){return("0000000000000000000"+e).substr(-t)}},Carvic.Model.UsersModel=function(){var e=this;e.UserList=ko.observableArray(),e.ResultCount=ko.computed(function(){return e.UserList()==undefined?0:e.UserList().length},e),e.NewUserUsername=ko.observable("new1"),e.NewUserFullName=ko.observable("New user"),e.NewUserPwd1=ko.observable(),e.NewUserPwd2=ko.observable(),e.NewUserType=ko.observable(),e.UserTypesArray=Carvic.Consts.UserTypesArray,e.UserTypes=ko.observableArray(e.UserTypesArray),e.UserTypesMap=Carvic.Consts.UserTypesMap,e.NewUserType(e.UserTypes()[1]),e.UserStatusesArray=Carvic.Consts.UserStatusesArray,e.UserStatuses=ko.observableArray(e.UserStatusesArray),e.UserStatusesMap=Carvic.Consts.UserStatusesMap,e.NewUserEditing=ko.observable(!1),e.NewUserEdit=ko.observable({FullName:ko.observable(""),Status:ko.observable(""),Type:ko.observable("")}),e.NewUserStartEditing=function(){e.NewUserEditing(!0)},e.NewUserCancelEditing=function(){e.NewUserEditing(!1)},e.LoadUsers=function(){e.UserList.removeAll();var t={};Carvic.Utils.Post({action:"get_users",data:t},function(t){for(var n=0;n<t.length;n++){var r=t[n];e.UserList.push({Username:r.username,FullName:r.full_name,Status:r.status,Type:r.type,LastLogin:new Date(Date.parse(r.last_login)),LastBadLogin:new Date(Date.parse(r.last_bad_login)),BadLoginCount:r.bad_login_cnt})}})},e.ShowUserDetails=function(e){window.location="user.html?u="+e.Username},e.SaveNewUser=function(){if(e.NewUserPwd1()!==e.NewUserPwd1()){alert("Entered password don't match.");return}var t={action:"new_user",data:{username:e.NewUserUsername(),full_name:e.NewUserFullName(),type:e.NewUserType().code,pwd:e.NewUserPwd1()}};Carvic.Utils.Post(t,function(n){e.ShowUserDetails({Username:t.data.username})})}},Carvic.Model.UserModel=function(){var e=this;e.ShowLogins=ko.observable(!1),e.ShowChanges=ko.observable(!0),e.CurrentUser=ko.observable({Username:ko.observable(""),FullName:ko.observable(""),StatusStr:ko.observable(""),Status:ko.observable(""),TypeStr:ko.observable(""),Type:ko.observable(""),LastLogin:new Date,LastBadLogin:new Date,BadLoginCount:0,LoginHistory:[],History:[]}),e.CurrentUserBackup={},e.EditUserPwd1=ko.observable(),e.EditUserPwd2=ko.observable(),e.UserTypesArray=Carvic.Consts.UserTypesArray,e.UserTypes=ko.observableArray(e.UserTypesArray),e.UserTypesMap=Carvic.Consts.UserTypesMap,e.UserStatusesArray=Carvic.Consts.UserStatusesArray,e.UserStatuses=ko.observableArray(e.UserStatusesArray),e.UserStatusesMap=Carvic.Consts.UserStatusesMap,e.CurrentUserEditing=ko.observable(!1),e.CurrentUserEditingPwd=ko.observable(!1),e.CurrentUserEdit=ko.observable({FullName:ko.observable(""),Status:ko.observable(""),Type:ko.observable("")}),e.CurrentUserStartEditing=function(){e.CurrentUserEdit().FullName(e.CurrentUser().FullName()),e.CurrentUserEdit().Status(Carvic.Utils.GetMatches({code:e.CurrentUser().Status()},e.UserStatusesArray)[0]),e.CurrentUserEdit().Type(Carvic.Utils.GetMatches({code:e.CurrentUser().Type()},e.UserTypesArray)[0]),e.CurrentUserEditing(!0)},e.CurrentUserStartEditingPwd=function(){e.CurrentUserEditingPwd(!0)},e.CurrentUserChangePwd=function(){if(e.EditUserPwd1()!==e.EditUserPwd2())alert("Passwords don't match");else{var t={username:e.CurrentUser().Username(),pwd:e.EditUserPwd1()};Carvic.Utils.Post({action:"change_pwd",data:t},function(t){e.CurrentUserEditingPwd(!1)})}},e.CurrentUserSave=function(){var t={action:"update_user",data:{username:e.CurrentUser().Username()}};e.CurrentUserEdit().FullName()!==e.CurrentUser().FullName()&&(t.data.full_name=e.CurrentUserEdit().FullName()),e.CurrentUserEdit().Status().code!==e.CurrentUser().Status()&&(t.data.status=e.CurrentUserEdit().Status().code),e.CurrentUserEdit().Type().code!==e.CurrentUser().Type()&&(t.data.type=e.CurrentUserEdit().Type().code),Carvic.Utils.Post(t,function(t){e.CurrentUserEditing(!1),e.LoadUser(e.CurrentUser().Username())})},e.CurrentUserCancelEditing=function(){e.CurrentUserEditing(!1)},e.CurrentUserCancelEditingPwd=function(){e.CurrentUserEditingPwd(!1)},e.LoadUser=function(t){Carvic.Utils.Post({action:"get_user",data:{username:t}},function(t){e.CurrentUser({Username:ko.observable(t.username),FullName:ko.observable(t.full_name),StatusStr:ko.observable(e.UserStatusesMap[t.status].title),Status:ko.observable(t.status),TypeStr:ko.observable(e.UserTypesMap[t.type].title),Type:ko.observable(t.type),LastLogin:new Date(Date.parse(t.last_login)),LastBadLogin:new Date(Date.parse(t.last_bad_login)),BadLoginCount:t.bad_login_cnt,LoginHistory:ko.observableArray(),History:ko.observableArray()}),e.DoShowChanges()})},e.LoadLoginHistory=function(){if(e.CurrentUser().LoginHistory().length>0)return;e.CurrentUser().LoginHistory.removeAll();var t={action:"get_logins",data:{username:e.CurrentUser().Username()}};Carvic.Utils.Post(t,function(t){for(var n=0;n<t.length;n++){var r=t[n];e.CurrentUser().LoginHistory.push(ko.observable({Ts:new Date(Date.parse(r.ts)),Ip:r.ip,LastAction:new Date(Date.parse(r.last_action))}))}})},e.LoadUserHistory=function(){if(e.CurrentUser().History().length>0)return;e.CurrentUser().History.removeAll();var t={action:"get_user_history",data:{username:e.CurrentUser().Username()}};Carvic.Utils.Post(t,function(t){for(var n=0;n<t.length;n++){var r=t[n];e.CurrentUser().History.push(ko.observable({Ts:new Date(Date.parse(r.ts)),Title:r.title,Description:r.description,Status:r.status,Code:r.code,Node:r.node,Css:r.code==="node_change"?"icon-edit":"icon-check"}))}})},e.CloseUserDetails=function(){window.location="users.html"},e.DisableUser=function(){e.CurrentUser().Status("inactive")},e.EnableUser=function(){e.CurrentUser().Status("active")},e.DoShowLogins=function(){e.LoadLoginHistory(),e.ShowLogins(!0),e.ShowChanges(!1)},e.DoShowChanges=function(){e.LoadUserHistory(),e.ShowLogins(!1),e.ShowChanges(!0)}},Carvic.Model.NodesModel=function(){var e=this;e.SearchResult=ko.observableArray(),e.AdvancedSearch=ko.observable(!1),e.NodeSearchName=ko.observable(""),e.NodeSearchId=ko.observable(""),e.NodeSearchScope=ko.observable(""),e.NodeSearchProject=ko.observable(""),e.NodeSearchSetup=ko.observable(""),e.NodeSearchBoxLabel=ko.observable(""),e.NodeSearchComment=ko.observable(""),e.NodeSearchCluster=ko.observable(),e.NodeSearchClusterList=ko.observableArray(),e.NodeSearchStatus=ko.observable(""),e.NodeSearchStatusList=ko.observableArray(),e.NodeSearchNetworkAddress=ko.observable(""),e.NodeSearchNetworkAddress2=ko.observable(""),e.NodeSearchMAC=ko.observable(""),e.NodeSearchFirmware=ko.observable(""),e.NodeSearchBootloader=ko.observable(""),e.NodeStatusesArray=Carvic.Consts.NodeStatusesArray,e.NodeStatuses=ko.observableArray(e.NodeStatusesArray),e.NodeStatusesMap=Carvic.Consts.NodeStatusesMap,e.CurrPage=ko.observable(0),e.PageCount=ko.observable(0),e.IncPageEnabled=ko.observable(!1),e.DecPageEnabled=ko.observable(!1),e.RecCount=ko.observable(0),e.IncPage=function(){e.CurrPage()<e.PageCount()&&(e.CurrPage(e.CurrPage()+1),e.SearchInner(!1))},e.DecPage=function(){var t=e.CurrPage()-1;t>=0&&(e.CurrPage(t),e.SearchInner(!1))},e.UpdatePageButtons=function(){e.IncPageEnabled(e.CurrPage()<e.PageCount()),e.DecPageEnabled(e.CurrPage()>0)},Carvic.Utils.LoadClusterList(e.NodeSearchClusterList),e.ResultCount=ko.computed(function(){return e.SearchResult()==undefined?0:e.SearchResult().length},e),e.DoAdvancedSearch=function(){e.AdvancedSearch(!0)},e.Search=function(){e.SearchInner(!0)},e.SearchInner=function(t){t&&(e.CurrPage(0),e.PageCount(0),e.UpdatePageButtons()),e.SearchResult.removeAll();var n={page:e.CurrPage()};e.NodeSearchId()!=""&&(n.id=Number(e.NodeSearchId())),e.NodeSearchName()!=""&&(n.name=e.NodeSearchName()),e.NodeSearchScope()!=""&&(n.scope=e.NodeSearchScope()),e.NodeSearchProject()!=""&&(n.project=e.NodeSearchProject()),e.NodeSearchSetup()!=""&&(n.setup=e.NodeSearchSetup()),e.NodeSearchBoxLabel()!=""&&(n.box_label=e.NodeSearchBoxLabel()),e.NodeSearchComment()!=""&&(n.comment=e.NodeSearchComment()),e.NodeSearchCluster()!=""&&(n.cluster=e.NodeSearchCluster()),e.NodeSearchStatus()!=""&&(n.status=e.NodeSearchStatus()),e.NodeSearchNetworkAddress()!=""&&(n.network_addr=e.NodeSearchNetworkAddress()),e.NodeSearchNetworkAddress2()!=""&&(n.network_addr2=e.NodeSearchNetworkAddress2()),e.NodeSearchMAC()!=""&&(n.mac=e.NodeSearchMAC()),e.NodeSearchFirmware()!=""&&(n.firmware=e.NodeSearchFirmware()),e.NodeSearchBootloader()!=""&&(n.bootloader=e.NodeSearchBootloader()),Carvic.Utils.Post({action:"get_nodes2",data:n},function(t){e.RecCount(t.count),e.PageCount(Math.floor(t.count/t.page_size)),e.UpdatePageButtons();for(var n=0;n<t.records.length;n++){var r=t.records[n],i=[];r.sensors.forEach(function(e){i.push(e.name+" ("+e.type+")")}),e.SearchResult.push(ko.observable({ID:r.id,Name:r.name,Status:ko.observable(r.status),Cluster:r.cluster,ClusterName:r.cluster_name,LON:r.loc_lon,LAT:r.loc_lat,Sensors:i.join(", ")}))}})},e.ShowNodeDetails=function(e){window.location="node.html?id="+encodeURI(encodeURI(e.ID))},e.OpenNewNode=function(e){window.location="new_node.html"},e.Search()},Carvic.Model.SingleNodeModel=function(){var e=this;e.CurrentNodeEditing=ko.observable(!1),e.NodeClusterList=ko.observableArray(),Carvic.Utils.LoadClusterList(e.NodeClusterList),e.NodeStatusesArray=Carvic.Consts.NodeStatusesArray,e.NodeStatuses=ko.observableArray(e.NodeStatusesArray),e.NodeStatusesMap=Carvic.Consts.NodeStatusesMap,e.NodeRolesArray=Carvic.Consts.NodeRolesArray,e.NodeRoles=ko.observableArray(e.NodeRolesArray),e.NodeRolesMap=Carvic.Consts.NodeRolesMap,e.NodeID=ko.observable(""),e.NodeName=ko.observable(""),e.NodeStatus=ko.observable("unknown"),e.NodeStatusStr=ko.computed(function(){return e.NodeStatusesMap[e.NodeStatus()].title},this),e.NodeCluster=ko.observable(),e.NodeClusterName=ko.observable(),e.NodeClusterUrl=ko.observable(),e.NodeLON=ko.observable(""),e.NodeLAT=ko.observable(""),e.NodeMapUrl=ko.observable(""),e.NodeSN=ko.observable(""),e.NodeMAC=ko.observable(""),e.NodeNetworkAddress=ko.observable(""),e.NodeNetworkAddress2=ko.observable(""),e.NodeFirmware=ko.observable(""),e.NodeBootloader=ko.observable(""),e.NodeSetup=ko.observable(""),e.NodeRole=ko.observable("device"),e.NodeRoleStr=ko.computed(function(){return e.NodeRolesMap[e.NodeRole()].title},this),e.NodeScope=ko.observable(""),e.NodeProject=ko.observable(""),e.NodeLocation=ko.observable(""),e.NodeUserComment=ko.observable(""),e.NodeBoxLabel=ko.observable(""),e.NodeLastScan=ko.observable(),e.Sensors=ko.observableArray(),e.Components=ko.observableArray(),e.ComponentsError=ko.observable(!1),e.NodeHistory=ko.observableArray(),e.OriginalData={},e.CurrentSensor=ko.observable(),e.ShowHistory=ko.observable(!1),e.ShowSensorHistory=ko.observable(!1),e.ShowSensorList=ko.observable(!1),e.ShowNodeData=ko.observable(!0),e.NodeEditComponentToAdd=ko.observable(),e.LoadDataFromObject=function(t){e.NodeID(t.id),e.NodeName(t.name),e.NodeStatus(t.status),e.NodeCluster(t.cluster),e.NodeClusterName(t.cluster_name),e.NodeClusterUrl("cluster.html?id="+encodeURI(t.cluster)),e.NodeLON(t.loc_lon),e.NodeLAT(t.loc_lat),e.NodeMapUrl("map.html?lat="+encodeURI(t.loc_lat)+"&lon="+encodeURI(t.loc_lon)+"&title="+encodeURI(t.name)),e.NodeSN(t.sn),e.NodeMAC(t.mac),e.NodeNetworkAddress(t.network_addr),e.NodeNetworkAddress2(t.network_addr2),e.NodeFirmware(t.firmware),e.NodeBootloader(t.bootloader),e.NodeSetup(t.setup),e.NodeRole(t.role),e.NodeScope(t.scope),e.NodeProject(t.project),e.NodeLocation(t.location),e.NodeUserComment(t.user_comment),e.NodeBoxLabel(t.box_label),e.NodeLastScan(new Date(Date.parse(t.last_scan)));var n=t.sensors;e.Components.removeAll();for(var r in t.components){var i=t.components[r];e.AddNewComponentId(i)}Carvic.Utils.Post({action:"get_sensors_for_node",data:{node:t.id}},function(t){e.Sensors.removeAll();for(var n=0;n<t.length;n++){var r=t[n],i=new Carvic.Model.NodeSensorModel(r,e);e.Sensors.push(ko.observable(i)),n==0&&e.DoShowSensor(i.ID)}}),e.ComponentsError(!1),Carvic.Utils.Post({action:"get_nodes_with_same_components",data:{node:t.id}},function(t){for(var n=0;n<t.length;n++){var r=t[n];for(var i=0;i<e.Components().length;i++){var s=e.Components()[i];console.log(s.Id(),r.id,s.Id()==r.id);if(s.Id()==r.id){s.OtherNodesCount(r.other_nodes_cnt),r.other_nodes_cnt>0&&e.ComponentsError(!0);continue}}}})},e.LoadNode=function(t){Carvic.Utils.Post({action:"get_node",data:{id:t}},function(t){e.OriginalData=t,e.LoadDataFromObject(t)})},e.RemoveComponent=function(t){e.Components.remove(function(e){return e.Id()==t})},e.AddNewComponentId=function(t){e.Components.push({Id:ko.observable(t),OtherNodesCount:ko.observable(0),Url:ko.observable("component.html?id="+encodeURI(t)),RemoveThisComponent:function(){e.RemoveComponent(this.Id())}})},e.AddNewComponent=function(){var t=e.NodeEditComponentToAdd();t.length>0&&(e.AddNewComponentId(t),e.NodeEditComponentToAdd(""))},e.StartEditNode=function(){e.CurrentNodeEditing(!0)},e.EndEditNode=function(){e.CurrentNodeEditing(!1);var t=[];e.Components().forEach(function(e){t.push(e.Id())});var n={action:"update_node",data:{id:e.NodeID(),name:e.NodeName(),status:e.NodeStatus(),cluster:e.NodeCluster(),loc_lon:e.NodeLON(),loc_lat:e.NodeLAT(),sn:e.NodeSN(),mac:e.NodeMAC(),network_addr:e.NodeNetworkAddress(),network_addr2:e.NodeNetworkAddress2(),firmware:e.NodeFirmware(),bootloader:e.NodeBootloader(),setup:e.NodeSetup(),role:e.NodeRole(),scope:e.NodeScope(),project:e.NodeProject(),location:e.NodeLocation(),user_comment:e.NodeUserComment(),box_label:e.NodeBoxLabel(),components:t}};Carvic.Utils.Post(n,function(t){e.LoadNode(n.data.id),e.NodeHistory.removeAll(),e.LoadNodeHistory()})},e.CancelEditNode=function(){e.LoadDataFromObject(e.OriginalData),e.CurrentNodeEditing(!1)},e.ShowNodeDetails=function(e){window.location="node.html?id="+encodeURI(e.ID)},e.CloseNodeDetails=function(){window.location="nodes.html"},e.LoadNodeHistory=function(){if(e.NodeHistory().length>0)return;e.NodeHistory.removeAll();var t={action:"get_node_history",data:{id:e.NodeID()}};Carvic.Utils.Post(t,function(t){for(var n=0;n<t.length;n++){var r=t[n];e.NodeHistory.push(ko.observable({Ts:new Date(Date.parse(r.ts)),Title:r.title,Description:r.description,Status:r.status,Code:r.code,User:r.user,UserFullName:r.user_full_name,Css:r.code==="node_change"?"icon-edit":"icon-check"}))}})},e.DoShowHistory=function(){e.LoadNodeHistory(!1),e.ShowHistory(!0),e.ShowSensorHistory(!1),e.ShowSensorList(!1),e.ShowNodeData(!1)},e.DoShowSensors=function(){e.ShowHistory(!1),e.ShowSensorHistory(!0),e.ShowSensorList(!1),e.ShowNodeData(!1)},e.DoShowSensor=function(t){for(var n=0;n<e.Sensors().length;n++){var r=e.Sensors()[n]();if(r.ID===t){e.CurrentSensor()!=null&&e.CurrentSensor().IsActive(!1),e.CurrentSensor(r),e.CurrentSensor().IsActive(!0),e.CurrentSensor().GetHistory();return}}},e.DoShowSensorList=function(){e.ShowHistory(!1),e.ShowSensorHistory(!1),e.ShowSensorList(!0),e.ShowNodeData(!1)},e.DoShowData=function(){e.ShowHistory(!1),e.ShowSensorHistory(!1),e.ShowSensorList(!1),e.ShowNodeData(!0)}},Carvic.Model.NewNodeModel=function(){var e=this;e.NodeClusterList=ko.observableArray(),Carvic.Utils.LoadClusterList(e.NodeClusterList),e.NodeID=ko.observable(""),e.NodeName=ko.observable(""),e.NodeStatus=ko.observable("unknown"),e.NodeCluster=ko.observable(),e.NodeLON=ko.observable(""),e.NodeLAT=ko.observable(""),e.NodeSN=ko.observable(""),e.NodeMAC=ko.observable(""),e.NodeNetworkAddress=ko.observable(""),e.NodeNetworkAddress2=ko.observable(""),e.NodeFirmware=ko.observable(""),e.NodeBootloader=ko.observable(""),e.NodeSetup=ko.observable(""),e.NodeRole=ko.observable("device"),e.NodeScope=ko.observable(""),e.NodeProject=ko.observable(""),e.NodeLocation=ko.observable(""),e.NodeUserComment=ko.observable(""),e.NodeBoxLabel=ko.observable(""),e.Sensors=ko.observableArray(),e.Components=ko.observableArray(),e.NodeHistory=ko.observableArray(),e.NodeComponentToAdd=ko.observable(""),e.NodeStatusesArray=Carvic.Consts.NodeStatusesArray,e.NodeStatuses=ko.observableArray(e.NodeStatusesArray),e.NodeStatusesMap=Carvic.Consts.NodeStatusesMap,e.NodeRolesArray=Carvic.Consts.NodeRolesArray,e.NodeRoles=ko.observableArray(e.NodeRolesArray),e.NodeRolesMap=Carvic.Consts.NodeRolesMap,e.RemoveComponent=function(t){e.Components.remove(function(e){return e.Id()==t})},e.AddNewComponentId=function(t){var n={Id:ko.observable(t),Url:ko.observable("component.html?id="+encodeURI(t)),AlreadyUsed:ko.observable(!1),RemoveThisComponent:function(){e.RemoveComponent(this.Id())}};e.Components.push(n);var r={action:"check_component_for_multiple_nodes",data:{component:t}};Carvic.Utils.Post(r,function(e){e.length>0&&n.AlreadyUsed(!0)})},e.AddNewComponent=function(){var t=e.NodeComponentToAdd();t.length>0&&(e.AddNewComponentId(t),e.NodeComponentToAdd(""))},e.LoadLastNode=function(){var t={action:"get_last_node"};Carvic.Utils.Post(t,function(t){e.NodeName(t.name),e.NodeCluster(t.cluster),e.NodeFirmware(t.firmware),e.NodeBootloader(t.bootloader),e.NodeRole(t.role),e.NodeScope(t.scope),e.NodeProject(t.project),e.NodeLocation(t.location)})},e.InsertNode=function(){var t=[];e.Components().forEach(function(e){t.push(e.Id())});var n={action:"add_node",data:{id:e.NodeID(),name:e.NodeName(),status:e.NodeStatus(),cluster:e.NodeCluster(),loc_lon:e.NodeLON(),loc_lat:e.NodeLAT(),sn:e.NodeSN(),mac:e.NodeMAC(),network_addr:e.NodeNetworkAddress(),network_addr2:e.NodeNetworkAddress2(),firmware:e.NodeFirmware(),bootloader:e.NodeBootloader(),setup:e.NodeSetup(),role:e.NodeRole(),scope:e.NodeScope(),project:e.NodeProject(),location:e.NodeLocation(),user_comment:e.NodeUserComment(),box_label:e.NodeBoxLabel(),components:t,sensors:[]}};Carvic.Utils.Post(n,function(e){window.location="node.html?id="+encodeURI(e.id)})}},Carvic.Model.NodeSensorModel=function(e,t){var n=this;n.Parent=t,n.IsActive=ko.observable(!1),n.ID=e.id,n.Name=ko.observable(e.name),n.Type=ko.observable(e.type),n.Description=ko.observable(e.description),n.History=ko.observableArray(),n.Show=function(){n.Parent.DoShowSensor(n.ID)},n.GetHistory=function(){if(n.History().length>0)return;n.History.removeAll();var e={action:"get_sensor_history",data:{id:n.ID,node:t.NodeID()}};Carvic.Utils.Post(e,function(e){for(var t=0;t<e.length;t++){var r=e[t];n.History.push(ko.observable({Ts:new Date(Date.parse(r.ts)),Value:r.value}))}})}},Carvic.Model.ComponentsModel=function(){var e=this;e.SearchResult=ko.observableArray(),e.SearchType=ko.observable(),e.SearchProject=ko.observable(""),e.SearchComment=ko.observable(""),e.SearchPN=ko.observable(""),e.SearchSN=ko.observable(""),e.SearchP=ko.observable(""),e.SearchS=ko.observable(""),e.SearchStatus=ko.observable(),e.ResultCount=ko.computed(function(){return e.SearchResult()==undefined?0:e.SearchResult().length},e),e.CurrPage=ko.observable(0),e.PageCount=ko.observable(0),e.IncPageEnabled=ko.observable(!1),e.DecPageEnabled=ko.observable(!1),e.RecCount=ko.observable(0),e.PageMode=ko.observable("search"),e.NewPN=ko.observable(""),e.NewP=ko.observable(""),e.NewS=ko.observable(""),e.NewSN1=ko.observable(""),e.NewSN2=ko.observable(""),e.NewType=ko.observable(),e.ComponentTypesArray=Carvic.Consts.ComponentTypesArray,e.ComponentTypes=ko.observableArray(e.ComponentTypesArray),e.ComponentTypesMap=Carvic.Consts.ComponentTypesMap,e.ComponentStatusesArray=Carvic.Consts.ComponentStatusesArray,e.ComponentStatuses=ko.observableArray(e.ComponentStatusesArray),e.ComponentStatusesMap=Carvic.Consts.ComponentStatusesMap,e.IncPage=function(){e.CurrPage()<e.PageCount()&&(e.CurrPage(e.CurrPage()+1),e.SearchInner(!1))},e.DecPage=function(){var t=e.CurrPage()-1;t>=0&&(e.CurrPage(t),e.SearchInner(!1))},e.UpdatePageButtons=function(){e.IncPageEnabled(e.CurrPage()<e.PageCount()),e.DecPageEnabled(e.CurrPage()>0)},e.Search=function(){e.SearchInner(!0)},e.SearchInner=function(t){t&&(e.CurrPage(0),e.PageCount(0),e.UpdatePageButtons()),e.SearchResult.removeAll();var n={page:e.CurrPage()};e.SearchType()!=undefined&&(n.type=e.SearchType()),e.SearchPN()!=""&&(n.product_number=e.SearchPN()),e.SearchSN()!=""&&(n.serial_number=e.SearchSN()),e.SearchP()!=""&&(n.production=e.SearchP()),e.SearchS()!=""&&(n.series=e.SearchS()),e.SearchProject()!=""&&(n.project=e.SearchProject()),e.SearchComment()!=""&&(n.comment=e.SearchComment()),e.SearchStatus()!=undefined&&(n.status=e.SearchStatus()),Carvic.Utils.Post({action:"get_components2",data:n},function(t){e.RecCount(t.count),e.PageCount(Math.floor(t.count/t.page_size)),e.UpdatePageButtons();for(var n=0;n<t.records.length;n++){var r=t.records[n];e.SearchResult.push(ko.observable({Type:ko.observable(r.type),PN:ko.observable(r.product_number),Status:ko.observable(r.status),StatusStr:ko.observable(e.ComponentStatusesMap[r.status].title),P:ko.observable(r.production),S:ko.observable(r.series),SN:ko.observable(r.serial_number),Project:ko.observable(r.project),Responsible:ko.observable(r.responsible),Comment:ko.observable(r.comment),ID:ko.observable(r.id)}))}})},e.ShowDetails=function(e){document.location="component.html?id="+encodeURI(e.ID())},e.SaveNewComponents=function(t){var n={pn:e.NewPN(),type:e.NewType(),p:e.NewP(),s:e.NewS(),sn_from:e.NewSN1(),sn_to:e.NewSN2()};Carvic.Utils.Post({action:"add_components",data:n},function(t){e.PageMode("search")})},e.StartAddingNewBatch=function(){e.PageMode("new_batch")},e.CancelAddingNewBatch=function(){e.PageMode("search")},e.Search()},Carvic.Model.ComponentModel=function(){var e=this;e.Editing=ko.observable(!1),e.Type=ko.observable(""),e.PN=ko.observable(""),e.Status=ko.observable(),e.StatusStr=ko.observable(""),e.P=ko.observable(""),e.S=ko.observable(),e.SN=ko.observable(),e.Project=ko.observable(),e.Responsible=ko.observable(),e.Comment=ko.observable(),e.ID=ko.observable(),e.History=ko.observableArray(),e.Nodes=ko.observableArray(),e.LastData={},e.ComponentTypesArray=Carvic.Consts.ComponentTypesArray,e.ComponentTypes=ko.observableArray(e.ComponentTypesArray),e.ComponentTypesMap=Carvic.Consts.ComponentTypesMap,e.ComponentStatusesArray=Carvic.Consts.ComponentStatusesArray,e.ComponentStatuses=ko.observableArray(e.ComponentStatusesArray),e.ComponentStatusesMap=Carvic.Consts.ComponentStatusesMap,e.Load=function(t){var n={id:t};Carvic.Utils.Post({action:"get_component",data:n},function(n){var r=n;e.Type(r.type),e.PN(r.product_number),e.Status(r.status),e.StatusStr(e.ComponentStatusesMap[r.status].title),e.P(r.production),e.S(r.series),e.SN(r.serial_number),e.Project(r.project),e.Responsible(r.responsible),e.Comment(r.comment),e.ID(r.id),e.LastData=r;for(var i=0;i<r.nodes.length;i++){var s=r.nodes[i];e.Nodes.push({Id:s.id,Name:s.name,Cluster:s.cluster,ClusterName:s.cluster_name,Url:"node.html?id="+encodeURI(s.id),ClusterUrl:"cluster.html?id="+encodeURI(s.cluster)})}e.History.removeAll();var o={action:"get_component_history",data:{id:t}};Carvic.Utils.Post(o,function(t){for(var n=0;n<t.length;n++){var r=t[n];e.History.push(ko.observable({Ts:new Date(Date.parse(r.ts)),Title:r.title,Description:r.description,Status:r.status,Code:r.code,User:r.user,UserFullName:r.user_full_name,Css:r.code==="component_change"?"icon-edit":"icon-check"}))}})})},e.ShowDetails=function(t){e.PageMode("edit")},e.CancelShowDetails=function(t){e.PageMode("search")},e.ShowHistory=function(e){},e.SaveComponent=function(t){var n={id:e.ID()};e.LastData.type!=e.Type()&&(n.type=e.Type()),e.LastData.product_number!=e.PN()&&(n.product_number=e.PN()),e.LastData.production!=e.P()&&(n.production=e.P()),e.LastData.series!=e.S()&&(n.series=e.S()),e.LastData.serial_number!=e.SN()&&(n.serial_number=e.SN()),e.LastData.status!=e.Status()&&(n.status=e.Status().code),e.LastData.project!=e.Project()&&(n.project=e.Project()),e.LastData.comment!=e.Comment()&&(n.comment=e.Comment());var r={action:"update_component",data:n};Carvic.Utils.Post(r,function(e){}),e.Editing(!1)},e.CancelEditing=function(){e.Editing(!1)},e.StartEditing=function(){e.Editing(!0)}},Carvic.Model.ClustersModel=function(){var e=this;e.PageMode=ko.observable("search"),e.SearchResult=ko.observableArray(),e.ResultCount=ko.computed(function(){return e.SearchResult()==undefined?0:e.SearchResult().length},e),e.NewId=ko.observable(""),e.NewName=ko.observable(""),e.NewUrl=ko.observable(""),e.NewType=ko.observable(),e.ClusterTypesArray=Carvic.Consts.ClusterTypesArray,e.ClusterTypes=ko.observableArray(e.ClusterTypesArray),e.ClusterTypesMap=Carvic.Consts.ClusterTypesMap,e.Search=function(){e.SearchResult.removeAll();var t={};Carvic.Utils.Post({action:"get_clusters",data:t},function(t){for(var n=0;n<t.length;n++){var r=t[n];e.SearchResult.push(ko.observable({Id:ko.observable(r.id),Name:ko.observable(r.name),Type:ko.observable(r.type),TypeStr:ko.observable(e.ClusterTypesMap[r.type].title),Url:ko.observable(r.url)}))}})},e.ShowDetails=function(e){document.location="cluster.html?id="+encodeURI(e.Id())},e.SaveNewCluster=function(t){var n={name:e.NewName(),id:e.NewId(),type:e.NewType(),url:e.NewUrl()};Carvic.Utils.Post({action:"add_cluster",data:n},function(t){e.Search(),e.PageMode("search")})},e.StartAddingNew=function(){e.PageMode("new")},e.CancelAddingNew=function(){e.PageMode("search")}},Carvic.Model.ClusterModel=function(){var e=this;e.Editing=ko.observable(!1),e.History=ko.observableArray(),e.Type=ko.observable(),e.TypeStr=ko.observable(),e.Id=ko.observable(),e.Name=ko.observable(),e.Url=ko.observable(),e.LastScan=ko.observable(),e.LastData={},e.ClusterTypesArray=Carvic.Consts.ClusterTypesArray,e.ClusterTypes=ko.observableArray(e.ClusterTypesArray),e.ClusterTypesMap=Carvic.Consts.ClusterTypesMap,e.Load=function(t){var n={id:t};Carvic.Utils.Post({action:"get_cluster",data:n},function(t){var n=t;e.Type(n.type),e.TypeStr(e.ClusterTypesMap[n.type].title),e.Name(n.name),e.Id(n.id),e.Url(n.url),e.LastScan(new Date(Date.parse(n.last_scan))),e.LastData=n,e.LoadHistory()})},e.LoadHistory=function(){e.History.removeAll();var t={action:"get_cluster_history",data:{id:e.Id()}};Carvic.Utils.Post(t,function(t){for(var n=0;n<t.length;n++){var r=t[n];e.History.push(ko.observable({Ts:new Date(Date.parse(r.ts)),Title:r.title,Description:r.description,Status:r.status,Code:r.code,User:r.user,UserFullName:r.user_full_name,Css:r.code==="component_change"?"icon-edit":"icon-check"}))}})},e.SaveCluster=function(t){var n={id:e.Id()};e.LastData.type!=e.Type()&&(n.type=e.Type()),e.LastData.name!=e.Name()&&(n.name=e.Name()),e.LastData.url!=e.Url()&&(n.url=e.Url());var r={action:"update_cluster",data:n};Carvic.Utils.Post(r,function(t){e.LoadHistory()}),e.Editing(!1)},e.CancelEditing=function(){e.Editing(!1)},e.StartEditing=function(){e.Editing(!0)}},Carvic.Model.HistoryModel=function(){var e=this;e.SearchResult=ko.observableArray(),e.User=ko.observable(""),e.UserList=ko.observableArray(),e.Component=ko.observable(""),e.Node=ko.observable(""),e.Cluster=ko.observable(""),e.ClusterList=ko.observableArray(),e.Keywords=ko.observable(""),e.CurrPage=ko.observable(0),e.PageCount=ko.observable(0),e.IncPageEnabled=ko.observable(!1),e.DecPageEnabled=ko.observable(!1),e.RecCount=ko.observable(0),e.From=ko.observable(""),e.To=ko.observable(""),Carvic.Utils.LoadClusterList(e.ClusterList),Carvic.Utils.LoadUserList(e.UserList),e.IncPage=function(){e.CurrPage()<e.PageCount()&&(e.CurrPage(e.CurrPage()+1),e.SearchInner(!1))},e.DecPage=function(){var t=e.CurrPage()-1;t>=0&&(e.CurrPage(t),e.SearchInner(!1))},e.UpdatePageButtons=function(){e.IncPageEnabled(e.CurrPage()<e.PageCount()),e.DecPageEnabled(e.CurrPage()>0)},e.Search=function(){e.SearchInner(!0)},e.SearchInner=function(t){t&&(e.CurrPage(0),e.PageCount(0),e.UpdatePageButtons()),e.SearchResult.removeAll();var n={page:e.CurrPage()};e.User()!=""&&(n.user=e.User()),e.Component()!=""&&(n.component=e.Component()),e.Node()!=""&&(n.node=Number(e.Node())),e.Cluster()!=""&&(n.cluster=e.Cluster()),e.Keywords()!=""&&(n.keywords=e.Keywords());var r=e.From();r&&r!=""&&(n.ts_from=Carvic.Utils.ParseDate(r));var i=e.To();i&&i!=""&&(n.ts_to=Carvic.Utils.ParseDate(i)),Carvic.Utils.Post({action:"get_history",data:n},function(t){e.RecCount(t.count),e.PageCount(Math.floor(t.count/t.page_size)),e.UpdatePageButtons();for(var n=0;n<t.records.length;n++){var r=t.records[n];r.component=r.component||"",r.component_url=r.component?"component.html?id="+encodeURI(r.component):null,r.cluster=r.cluster||"",r.cluster_name=r.cluster_name||"",r.cluster_url=r.cluster?"cluster.html?id="+encodeURI(r.cluster):null,r.node=r.node||"",r.node_url=r.node?"node.html?id="+encodeURI(r.node):null,r.ts=new Date(r.ts),e.SearchResult.push(ko.observable(r))}})},e.Search()},Carvic.Model.SettingsModel=function(){var e=this;e.CurrentFullName=ko.observable(),e.NewPwd1=ko.observable(),e.NewPwd2=ko.observable(),e.Msg=ko.observable(""),e.MsgType=ko.observable(""),e.SaveNewFullName=function(){var t={full_name:e.CurrentFullName()};Carvic.Utils.Post({action:"change_my_full_name",data:t},function(t){e.Msg("Full name changed successfully"
)})},e.ChangePassword=function(){if(e.NewPwd1()!==e.NewPwd2())e.Msg("Passwords don't match"),e.MsgType("error");else{var t={pwd:e.NewPwd1()};Carvic.Utils.Post({action:"change_pwd",data:t},function(t){e.Msg("Password changed successfully")})}}},Carvic.Model.Refresh=function(){},Carvic.ReloadStats=function(){var e={action:"get_node_stats"};Carvic.Utils.Post(e,function(e){Carvic.Model.Stats().Nodes().all(e.all),Carvic.Model.Stats().Nodes().active(e.active),Carvic.Model.Stats().Nodes().active_percent(e.active_percent)});var t={action:"get_sensor_stats"};Carvic.Utils.Post(t,function(e){Carvic.Model.Stats().Sensors().all(e.all),Carvic.Model.Stats().Sensors().active(e.active),Carvic.Model.Stats().Sensors().active_percent(e.active_percent)});var n={action:"get_user_stats"};Carvic.Utils.Post(n,function(e){Carvic.Model.Stats().Users().all(e.all),Carvic.Model.Stats().Users().active(e.active),Carvic.Model.Stats().Users().admins(e.admins)});var r={action:"get_cluster_stats"};Carvic.Utils.Post(r,function(e){for(var t in e){var n=e[t];n.url="cluster.html?id="+encodeURI(n.id),n.nodes_activep=Math.round(100*n.nodes_activep)/100,n.sensors_activep=Math.round(100*n.sensors_activep)/100,Carvic.Model.Stats().Clusters.push(n)}})},Carvic.InitAdminPage=function(){Carvic.Model.Admin={},Carvic.Utils.SetCurrentUser(Carvic.Model.Admin)},Carvic.InitUserList=function(){Carvic.Model.Users=new Carvic.Model.UsersModel,Carvic.Model.Users.LoadUsers(),Carvic.Utils.SetCurrentUser(Carvic.Model.Users)},Carvic.InitSingleUser=function(){Carvic.Model.User=new Carvic.Model.UserModel;var e=Carvic.Utils.GetUrlParam("u");e?Carvic.Model.User.LoadUser(e):Carvic.Model.User.LoadUser(5),Carvic.Utils.SetCurrentUser(Carvic.Model.User)},Carvic.InitComponentList=function(){Carvic.Model.Components=new Carvic.Model.ComponentsModel,Carvic.Utils.SetCurrentUser(Carvic.Model.Components)},Carvic.InitHistoryList=function(){Carvic.Model.History=new Carvic.Model.HistoryModel,Carvic.Utils.SetCurrentUser(Carvic.Model.History)},Carvic.InitSingleComponentList=function(){var e=Carvic.Utils.GetUrlParam("id");Carvic.Model.Component=new Carvic.Model.ComponentModel,Carvic.Model.Component.Load(e),Carvic.Utils.SetCurrentUser(Carvic.Model.Component)},Carvic.InitClusterList=function(){Carvic.Model.Clusters=new Carvic.Model.ClustersModel,Carvic.Model.Clusters.Search(),Carvic.Utils.SetCurrentUser(Carvic.Model.Clusters)},Carvic.InitSingleCluster=function(){var e=Carvic.Utils.GetUrlParam("id");Carvic.Model.Cluster=new Carvic.Model.ClusterModel,Carvic.Model.Cluster.Load(e),Carvic.Utils.SetCurrentUser(Carvic.Model.Cluster)},Carvic.InitNodeList=function(){Carvic.Model.Nodes=new Carvic.Model.NodesModel,Carvic.Utils.SetCurrentUser(Carvic.Model.Nodes)},Carvic.InitSingleNode=function(){Carvic.Model.SingleNode=new Carvic.Model.SingleNodeModel;var e=Carvic.Utils.GetUrlParam("id");e?Carvic.Model.SingleNode.LoadNode(e):Carvic.Model.SingleNode.LoadNode(5),Carvic.Utils.SetCurrentUser(Carvic.Model.SingleNode)},Carvic.InitNewNode=function(){Carvic.Model.NewNode=new Carvic.Model.NewNodeModel,Carvic.Utils.SetCurrentUser(Carvic.Model.NewNode)},Carvic.InitStats=function(){Carvic.Model.Stats=ko.observable({Nodes:ko.observable({all:ko.observable(),active:ko.observable(),active_percent:ko.observable()}),Sensors:ko.observable({all:ko.observable(),active:ko.observable(),active_percent:ko.observable()}),Users:ko.observable({all:ko.observable(),active:ko.observable(),admins:ko.observable()}),Clusters:ko.observableArray()}),Carvic.Utils.SetCurrentUser(Carvic.Model.Stats()),Carvic.ReloadStats()},Carvic.InitSettings=function(){Carvic.Model.Settings=new Carvic.Model.SettingsModel,Carvic.Utils.SetCurrentUser(Carvic.Model.Settings,function(){Carvic.Model.Settings.CurrentFullName(Carvic.Model.Settings.StdData.CurrentUserFullname())})};